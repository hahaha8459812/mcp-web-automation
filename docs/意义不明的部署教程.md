## 🚀 在 /opt 目录部署 MCP Web Automation Tool - 混合部署版

> 在 Linux 系统的 /opt 目录下进行生产环境混合部署 - 支持HTTP API + MCP HTTP + MCP stdio

---

## 📋 **部署概述**

`/opt` 目录是 Linux 系统中安装第三方软件的标准位置，适合生产环境混合部署。

### 🎯 **混合部署特性**
- **三种访问方式**: HTTP API (29527) + MCP HTTP (29528) + MCP stdio
- **无认证限制**: 移除API密钥要求，支持直接访问
- **无并发限制**: 支持无限数量AI客户端同时连接
- **高可用性**: 自动健康检查、进程管理、日志轮转

---

## 1️⃣ **连接服务器并准备环境**

### 🔐 **连接到服务器**
```bash
# 通过 SSH 连接到服务器
ssh username@your-server-ip

# 切换到 root 用户（推荐）
sudo su -
# 或者每个命令前加 sudo
```

### 📁 **进入 /opt 目录**
```bash
# 进入 /opt 目录
cd /opt

# 查看当前目录
pwd
# 输出：/opt
```

---

## 2️⃣ **克隆项目和切换分支**

### 📥 **下载项目代码**
```bash
# 在 /opt 目录下克隆项目
git clone https://github.com/hahaha8459812/mcp-web-automation.git

# 查看创建的目录
ls -la mcp-web-automation/
```

### 🌿 **切换到混合部署分支**
```bash
# 进入项目目录
cd mcp-web-automation

# 切换到混合部署分支（重要！）
git checkout feature/mcp-server-implementation

# 确认当前分支
git branch --show-current
# 输出：feature/mcp-server-implementation

# 查看最新提交
git log --oneline -5
```

### 👤 **设置目录权限**
```bash
# 方案 A：保持 root 权限（推荐生产环境）
chown -R root:root /opt/mcp-web-automation
chmod -R 755 /opt/mcp-web-automation

# 方案 B：分配给特定用户（如果有专门的服务用户）
# 创建专用用户（可选）
# useradd -r -s /bin/false mcp-user
# chown -R mcp-user:mcp-user /opt/mcp-web-automation

# 方案 C：分配给当前用户
# chown -R $SUDO_USER:$SUDO_USER /opt/mcp-web-automation
```

---

## 3️⃣ **环境检查和依赖安装**

### 📂 **进入项目目录**
```bash
# 确认当前路径
pwd
# 输出：/opt/mcp-web-automation
```

### 🔍 **检查系统环境**
```bash
# 检查Node.js版本（需要v18+）
node --version

# 如果没有Node.js，安装Node.js 20
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# 检查Docker版本
docker --version
docker-compose --version

# 如果没有Docker，安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh
sudo usermod -aG docker $USER
```

### 📦 **安装项目依赖**
```bash
# 安装npm依赖
npm install

# 验证依赖安装
npm list --depth=0
```

---

## 4️⃣ **配置文件设置**

### ⚙️ **创建配置文件**
```bash
# 复制HTTP API配置文件
cp config/config.example.json config/config.json

# 检查MCP配置文件是否存在
ls -la mcp-config.json

# 如果不存在，创建默认MCP配置
cat > mcp-config.json << 'EOF'
{
  "server": {
    "name": "web-automation-mcp",
    "version": "1.0.0",
    "description": "Web automation tool with MCP support"
  },
  "capabilities": {
    "tools": true,
    "resources": false,
    "prompts": false
  },
  "tools": {
    "web_navigate": { "enabled": true, "description": "Navigate to web pages", "category": "navigation" },
    "web_extract_content": { "enabled": true, "description": "Extract content from web pages", "category": "extraction" },
    "web_click_element": { "enabled": true, "description": "Click on web page elements", "category": "interaction" },
    "web_input_text": { "enabled": true, "description": "Input text into form fields", "category": "interaction" },
    "web_screenshot": { "enabled": true, "description": "Take screenshots of web pages", "category": "capture" },
    "web_manage_bookmarks": { "enabled": true, "description": "Manage website bookmarks", "category": "data" },
    "web_manage_credentials": { "enabled": true, "description": "Manage website credentials", "category": "data" }
  },
  "http": {
    "port": 29528,
    "host": "0.0.0.0",
    "cors": { "enabled": true, "origin": "*" }
  },
  "logging": {
    "level": "info",
    "file": "logs/mcp-http.log",
    "format": "json"
  }
}
EOF
```

### 🔧 **创建必要目录**
```bash
# 创建数据和日志目录
mkdir -p data logs

# 设置权限
chmod 755 data logs
```

---

## 5️⃣ **混合部署启动**

### 🚀 **执行混合部署**
```bash
# 赋予混合部署脚本执行权限
chmod +x start-hybrid.sh

# 启动混合服务（HTTP API + MCP HTTP）
./start-hybrid.sh start

# 查看启动日志
./start-hybrid.sh logs
```

### ✅ **验证部署**
```bash
# 检查服务状态
./start-hybrid.sh status

# 测试HTTP API服务
curl http://localhost:29527/health

# 测试MCP HTTP服务  
curl http://localhost:29528/health

# 运行完整测试
./start-hybrid.sh test
```

---

## 6️⃣ **防火墙配置**

### 🔥 **开放必要端口**
```bash
# Ubuntu/Debian 系统
sudo ufw allow 29527/tcp comment "MCP Web Automation HTTP API"
sudo ufw allow 29528/tcp comment "MCP Web Automation MCP HTTP"
sudo ufw status

# CentOS/RHEL 系统
sudo firewall-cmd --add-port=29527/tcp --permanent --zone=public
sudo firewall-cmd --add-port=29528/tcp --permanent --zone=public
sudo firewall-cmd --reload
sudo firewall-cmd --list-all

# 验证端口开放
telnet localhost 29527
telnet localhost 29528
```

### 🌐 **测试远程访问**
```bash
# 从其他机器测试访问
curl http://your-server-ip:29527/health
curl http://your-server-ip:29528/health
```

---

## 7️⃣ **系统服务配置（可选）**

### 🔧 **创建HTTP API系统服务**
```bash
# 创建HTTP API服务文件
sudo tee /etc/systemd/system/mcp-http-api.service > /dev/null << 'EOF'
[Unit]
Description=MCP Web Automation HTTP API Service
After=network.target
Wants=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/mcp-web-automation
ExecStart=/usr/bin/node src/index.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production
Environment=TZ=Asia/Shanghai

# 日志配置
StandardOutput=append:/opt/mcp-web-automation/logs/http-api-systemd.log
StandardError=append:/opt/mcp-web-automation/logs/http-api-systemd.log

[Install]
WantedBy=multi-user.target
EOF
```

### 🔧 **创建MCP HTTP系统服务**
```bash
# 创建MCP HTTP服务文件
sudo tee /etc/systemd/system/mcp-http-server.service > /dev/null << 'EOF'
[Unit]
Description=MCP Web Automation MCP HTTP Service
After=network.target
Wants=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/mcp-web-automation
ExecStart=/usr/bin/node src/mcp-remote-server.js http
Restart=always
RestartSec=10
Environment=NODE_ENV=production
Environment=TZ=Asia/Shanghai

# 日志配置
StandardOutput=append:/opt/mcp-web-automation/logs/mcp-http-systemd.log
StandardError=append:/opt/mcp-web-automation/logs/mcp-http-systemd.log

[Install]
WantedBy=multi-user.target
EOF
```

### 🎯 **启用和启动系统服务**
```bash
# 重载systemd配置
sudo systemctl daemon-reload

# 启用服务开机自启
sudo systemctl enable mcp-http-api
sudo systemctl enable mcp-http-server

# 启动服务
sudo systemctl start mcp-http-api
sudo systemctl start mcp-http-server

# 检查服务状态
sudo systemctl status mcp-http-api
sudo systemctl status mcp-http-server

# 查看服务日志
sudo journalctl -u mcp-http-api -f
sudo journalctl -u mcp-http-server -f
```

---

## 8️⃣ **日志管理配置**

### 📝 **配置logrotate**
```bash
# 创建日志轮转配置
sudo tee /etc/logrotate.d/mcp-web-automation > /dev/null << 'EOF'
/opt/mcp-web-automation/logs/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    copytruncate
    su root root
}
EOF

# 测试logrotate配置
sudo logrotate -d /etc/logrotate.d/mcp-web-automation

# 手动执行一次日志轮转测试
sudo logrotate -f /etc/logrotate.d/mcp-web-automation
```

---

## 9️⃣ **管理别名配置（便于运维）**

### 💻 **创建管理别名**
```bash
# 添加管理别名到 .bashrc
cat >> ~/.bashrc << 'EOF'

# MCP Web Automation 混合部署管理别名
alias mcp-cd='cd /opt/mcp-web-automation'
alias mcp-start='cd /opt/mcp-web-automation && ./start-hybrid.sh start'
alias mcp-stop='cd /opt/mcp-web-automation && ./start-hybrid.sh stop'
alias mcp-restart='cd /opt/mcp-web-automation && ./start-hybrid.sh restart'
alias mcp-status='cd /opt/mcp-web-automation && ./start-hybrid.sh status'
alias mcp-logs='cd /opt/mcp-web-automation && ./start-hybrid.sh logs'
alias mcp-test='cd /opt/mcp-web-automation && ./start-hybrid.sh test'

# 服务管理别名
alias mcp-service-status='systemctl status mcp-http-api mcp-http-server'
alias mcp-service-start='systemctl start mcp-http-api mcp-http-server'
alias mcp-service-stop='systemctl stop mcp-http-api mcp-http-server'
alias mcp-service-restart='systemctl restart mcp-http-api mcp-http-server'

# 健康检查别名
alias mcp-health='curl -s http://localhost:29527/health && echo && curl -s http://localhost:29528/health'
alias mcp-health-api='curl -s http://localhost:29527/health | jq .'
alias mcp-health-mcp='curl -s http://localhost:29528/health | jq .'

# 日志查看别名
alias mcp-tail-api='tail -f /opt/mcp-web-automation/logs/http-api.log'
alias mcp-tail-mcp='tail -f /opt/mcp-web-automation/logs/mcp-http.log'
alias mcp-tail-all='tail -f /opt/mcp-web-automation/logs/*.log'

EOF

# 重新加载 .bashrc
source ~/.bashrc

# 验证别名
mcp-status
```

---

## 🔟 **AI客户端配置指导**

### 💻 **本地AI客户端配置**

#### Claude Desktop配置
```json
{
  "mcpServers": {
    "web-automation-local": {
      "command": "ssh",
      "args": [
        "your-server-ip",
        "cd /opt/mcp-web-automation && node src/mcp-server.js"
      ],
      "env": {
        "NODE_ENV": "production"
      }
    }
  }
}
```

#### Cursor IDE配置
```json
{
  "mcp": {
    "servers": [
      {
        "name": "web-automation-remote",
        "command": "ssh",
        "args": ["your-server-ip", "cd /opt/mcp-web-automation && node src/mcp-server.js"]
      }
    ]
  }
}
```

### 🌐 **远程AI客户端配置**

#### HTTP MCP客户端配置
```json
{
  "mcpServers": {
    "web-automation-http": {
      "url": "http://your-server-ip:29528/mcp",
      "type": "sse",
      "name": "Web Automation Remote"
    }
  }
}
```

### 🧪 **客户端连接测试**
```bash
# 测试SSH连接（用于远程MCP stdio）
ssh your-server-ip "cd /opt/mcp-web-automation && timeout 5s node src/mcp-server.js"

# 测试HTTP MCP连接
curl http://your-server-ip:29528/mcp

# 测试完整工作流
curl -X POST -H "Content-Type: application/json" \
     -d '{"url":"https://httpbin.org/get","client_id":"test"}' \
     http://your-server-ip:29527/api/navigate
```

---

## 1️⃣1️⃣ **监控和维护**

### 📊 **创建监控脚本**
```bash
# 创建监控脚本
cat > /opt/mcp-web-automation/monitor.sh << 'EOF'
#!/bin/bash

# MCP Web Automation 混合服务监控脚本
LOG_FILE="/opt/mcp-web-automation/logs/monitor.log"

log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> $LOG_FILE
}

# 检查HTTP API服务
if curl -s http://localhost:29527/health > /dev/null; then
    log_message "✅ HTTP API服务正常"
else
    log_message "❌ HTTP API服务异常，尝试重启"
    /opt/mcp-web-automation/start-hybrid.sh restart
fi

# 检查MCP HTTP服务
if curl -s http://localhost:29528/health > /dev/null; then
    log_message "✅ MCP HTTP服务正常"
else
    log_message "❌ MCP HTTP服务异常，尝试重启"
    /opt/mcp-web-automation/start-hybrid.sh restart
fi

# 检查磁盘空间
DISK_USAGE=$(df /opt | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    log_message "⚠️ 磁盘使用率过高: ${DISK_USAGE}%"
fi

# 清理7天前的日志
find /opt/mcp-web-automation/logs -name "*.log.old" -mtime +7 -delete

log_message "🔍 监控检查完成"
EOF

chmod +x /opt/mcp-web-automation/monitor.sh
```

### ⏰ **配置定时监控**
```bash
# 添加crontab定时任务
(crontab -l 2>/dev/null; echo "*/5 * * * * /opt/mcp-web-automation/monitor.sh") | crontab -

# 查看crontab配置
crontab -l

# 手动测试监控脚本
/opt/mcp-web-automation/monitor.sh
tail -10 /opt/mcp-web-automation/logs/monitor.log
```

---

## 1️⃣2️⃣ **备份和恢复**

### 💾 **创建备份脚本**
```bash
# 创建备份脚本
cat > /opt/mcp-web-automation/backup.sh << 'EOF'
#!/bin/bash

BACKUP_DIR="/opt/mcp-web-automation/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="mcp-backup-${DATE}.tar.gz"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 停止服务
./start-hybrid.sh stop

# 创建备份
tar -czf $BACKUP_DIR/$BACKUP_FILE \
    --exclude='logs/*.log' \
    --exclude='node_modules' \
    --exclude='backups' \
    -C /opt mcp-web-automation

# 重启服务
./start-hybrid.sh start

echo "✅ 备份完成: $BACKUP_DIR/$BACKUP_FILE"

# 清理30天前的备份
find $BACKUP_DIR -name "mcp-backup-*.tar.gz" -mtime +30 -delete
EOF

chmod +x /opt/mcp-web-automation/backup.sh

# 执行备份测试
/opt/mcp-web-automation/backup.sh
ls -la /opt/mcp-web-automation/backups/
```

---

## 1️⃣3️⃣ **升级和更新**

### 🔄 **创建更新脚本**
```bash
# 创建更新脚本
cat > /opt/mcp-web-automation/update.sh << 'EOF'
#!/bin/bash

echo "🔄 开始更新MCP Web Automation..."

# 进入项目目录
cd /opt/mcp-web-automation

# 备份当前版本
./backup.sh

# 停止服务
./start-hybrid.sh stop

# 拉取最新代码
git fetch origin
git checkout feature/mcp-server-implementation
git pull origin feature/mcp-server-implementation

# 更新依赖
npm install

# 重启服务
./start-hybrid.sh start

# 验证更新
sleep 10
./start-hybrid.sh test

echo "✅ 更新完成！"
EOF

chmod +x /opt/mcp-web-automation/update.sh
```

---

## 📋 **部署完成检查清单**

### ✅ **部署验证清单**
```bash
# 1. 检查目录结构
ls -la /opt/mcp-web-automation/

# 2. 检查分支
cd /opt/mcp-web-automation && git branch --show-current

# 3. 检查服务状态
./start-hybrid.sh status

# 4. 检查端口监听
netstat -tulnp | grep -E ":(29527|29528)"

# 5. 检查健康状态
curl http://localhost:29527/health
curl http://localhost:29528/health

# 6. 检查远程访问（替换your-server-ip）
curl http://your-server-ip:29527/health
curl http://your-server-ip:29528/health

# 7. 检查日志
ls -la logs/
./start-hybrid.sh logs

# 8. 检查系统服务（如果配置了）
systemctl status mcp-http-api mcp-http-server

# 9. 检查防火墙
sudo ufw status | grep -E "(29527|29528)"

# 10. 检查别名
mcp-health
```

### 🎉 **部署成功确认**
如果以上检查都通过，说明混合部署成功！

**现在您可以：**
- ✅ 通过HTTP API访问: `http://your-server:29527`
- ✅ 通过MCP HTTP访问: `http://your-server:29528/mcp`  
- ✅ 通过MCP stdio访问: `ssh your-server "cd /opt/mcp-web-automation && node src/mcp-server.js"`
- ✅ 无需认证，无并发限制
- ✅ 支持无限数量的AI客户端

---

## 🆘 **故障排除**

### 常见问题快速解决
```bash
# 服务启动失败
./start-hybrid.sh restart

# 端口被占用
lsof -i :29527 && lsof -i :29528

# 权限问题
chmod -R 755 /opt/mcp-web-automation

# 依赖问题
rm -rf node_modules && npm install

# 查看详细错误
./start-hybrid.sh logs

# 检查系统资源
free -h && df -h
```

---

**🎊 恭喜！您已成功在 `/opt` 目录完成MCP Web Automation Tool的混合部署！**

*部署指南最后更新: 2025-08-12 | 混合部署版 Hybrid Deployment Version*
