## 🚀 在 /opt 目录部署 MCP Web Automation Tool

> 在 Linux 系统的 /opt 目录下进行生产环境部署

---

## 📋 **部署概述**

`/opt` 目录是 Linux 系统中安装第三方软件的标准位置，适合生产环境部署。

---

## 1️⃣ **连接服务器并准备环境**

### 🔐 **连接到服务器**
```bash
# 通过 SSH 连接到服务器
ssh username@your-server-ip

# 切换到 root 用户（推荐）
sudo su -
# 或者每个命令前加 sudo
```

### 📁 **进入 /opt 目录**
```bash
# 进入 /opt 目录
cd /opt

# 查看当前目录
pwd
# 输出：/opt
```

---

## 2️⃣ **克隆项目**

### 📥 **下载项目代码**
```bash
# 在 /opt 目录下克隆项目
git clone https://github.com/hahaha8459812/mcp-web-automation.git

# 查看创建的目录
ls -la mcp-web-automation/
```

### 👤 **设置目录权限**
```bash
# 方案 A：保持 root 权限（推荐生产环境）
chown -R root:root /opt/mcp-web-automation
chmod -R 755 /opt/mcp-web-automation

# 方案 B：分配给特定用户（如果有专门的服务用户）
# 创建专用用户（可选）
# useradd -r -s /bin/false mcp-user
# chown -R mcp-user:mcp-user /opt/mcp-web-automation

# 方案 C：分配给当前用户
# chown -R $SUDO_USER:$SUDO_USER /opt/mcp-web-automation
```

---

## 3️⃣ **执行安装**

### 📂 **进入项目目录**
```bash
# 进入项目目录
cd /opt/mcp-web-automation

# 确认当前路径
pwd
# 输出：/opt/mcp-web-automation
```

### 🔧 **赋予脚本执行权限**
```bash
# 赋予安装脚本执行权限
chmod +x scripts/install.sh
chmod +x scripts/start.sh

# 确认权限设置
ls -la scripts/
```

### 🚀 **执行一键安装**
```bash
# 运行安装脚本
./scripts/install.sh
```

---

## 4️⃣ **验证部署**

### 📊 **检查服务状态**
```bash
# 查看服务状态
./scripts/start.sh status

# 查看容器是否正在运行
docker-compose ps
```

### 🔍 **测试服务**
```bash
# 本地健康检查
curl http://localhost:29527/health

# 查看 API 密钥
cat /opt/mcp-web-automation/config/config.json | grep api_key

# 带认证的测试（替换为实际密钥）
curl -H "X-API-Key: your-actual-api-key" http://localhost:29527/health
```

---

## 5️⃣ **创建系统服务（推荐）**

### 📝 **创建 systemd 服务文件**
```bash
# 创建系统服务文件
cat > /etc/systemd/system/mcp-web-automation.service << 'EOF'
[Unit]
Description=MCP Web Automation Tool
Documentation=https://github.com/hahaha8459812/mcp-web-automation
After=docker.service
Requires=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/mcp-web-automation
ExecStart=/opt/mcp-web-automation/scripts/start.sh start
ExecStop=/opt/mcp-web-automation/scripts/start.sh stop
ExecReload=/opt/mcp-web-automation/scripts/start.sh restart
TimeoutStartSec=300
User=root
Group=root

[Install]
WantedBy=multi-user.target
EOF
```

### 🔄 **启用系统服务**
```bash
# 重新加载 systemd 配置
systemctl daemon-reload

# 启用服务（开机自启）
systemctl enable mcp-web-automation.service

# 查看服务状态
systemctl status mcp-web-automation.service
```

---

## 6️⃣ **配置防火墙和安全**

### 🔥 **开放端口**
```bash
# Ubuntu/Debian (UFW)
ufw allow 29527/tcp
ufw status

# CentOS/RHEL (firewalld)
firewall-cmd --permanent --add-port=29527/tcp
firewall-cmd --reload
firewall-cmd --list-ports
```

### 🔐 **生成更强的 API 密钥**
```bash
# 生成新的 32 位随机密钥
NEW_API_KEY=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-32)
echo "新的 API 密钥: $NEW_API_KEY"

# 备份原配置
cp /opt/mcp-web-automation/config/config.json /opt/mcp-web-automation/config/config.json.backup

# 替换 API 密钥
sed -i "s/\"api_key\": \"[^\"]*\"/\"api_key\": \"$NEW_API_KEY\"/g" /opt/mcp-web-automation/config/config.json

# 重启服务应用新配置
cd /opt/mcp-web-automation
./scripts/start.sh restart

# 显示新密钥
echo "请记录新的 API 密钥: $NEW_API_KEY"
```

---

## 7️⃣ **设置日志轮转**

### 📝 **配置 logrotate**
```bash
# 创建日志轮转配置
cat > /etc/logrotate.d/mcp-web-automation << 'EOF'
/opt/mcp-web-automation/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        cd /opt/mcp-web-automation && ./scripts/start.sh restart > /dev/null 2>&1 || true
    endscript
}
EOF

# 测试 logrotate 配置
logrotate -d /etc/logrotate.d/mcp-web-automation
```

---

## 8️⃣ **创建管理别名**

### ⚡ **添加便捷命令**
```bash
# 为所有用户添加管理别名
cat >> /etc/bash.bashrc << 'EOF'

# MCP Web Automation Tool Aliases
alias mcp-status='cd /opt/mcp-web-automation && ./scripts/start.sh status'
alias mcp-logs='cd /opt/mcp-web-automation && ./scripts/start.sh logs -f'
alias mcp-restart='cd /opt/mcp-web-automation && ./scripts/start.sh restart'
alias mcp-start='cd /opt/mcp-web-automation && ./scripts/start.sh start'
alias mcp-stop='cd /opt/mcp-web-automation && ./scripts/start.sh stop'
alias mcp-backup='cd /opt/mcp-web-automation && ./scripts/start.sh backup'
alias mcp-health='curl -H "X-API-Key: $(grep -o "\"api_key\": *\"[^\"]*\"" /opt/mcp-web-automation/config/config.json | cut -d "\"" -f4)" http://localhost:29527/health'
EOF

# 重新加载 bashrc
source /etc/bash.bashrc
```

---

## 9️⃣ **验证完整部署**

### ✅ **完整测试**
```bash
# 使用新的别名测试
mcp-status

# 健康检查
mcp-health

# 查看日志
mcp-logs
# 按 Ctrl+C 退出日志查看

# 测试系统服务
systemctl status mcp-web-automation

# 外网访问测试（如果配置了外网）
curl -H "X-API-Key: your-api-key" http://your-server-ip:29527/health
```

---

## 🔧 **日常管理命令**

### 📋 **常用操作**
```bash
# 方式 1：使用系统服务
systemctl start mcp-web-automation     # 启动
systemctl stop mcp-web-automation      # 停止
systemctl restart mcp-web-automation   # 重启
systemctl status mcp-web-automation    # 状态

# 方式 2：使用项目脚本
cd /opt/mcp-web-automation
./scripts/start.sh start               # 启动
./scripts/start.sh stop                # 停止
./scripts/start.sh restart             # 重启
./scripts/start.sh status              # 状态

# 方式 3：使用别名（任何目录下）
mcp-start                              # 启动
mcp-stop                               # 停止
mcp-restart                            # 重启
mcp-status                             # 状态
mcp-logs                               # 查看日志
mcp-health                             # 健康检查
```

---

## 📁 **最终目录结构**

```
/opt/mcp-web-automation/
├── config/
│   ├── config.json              # 生产配置
│   ├── config.json.backup       # 配置备份
│   └── config.example.json
├── data/
│   └── user-data.json           # 用户数据
├── logs/
│   └── mcp-web-automation.log   # 应用日志
├── backups/                     # 自动备份
├── src/                         # 源代码
├── scripts/                     # 管理脚本
└── docs/                        # 文档
```

---

## 🎉 **部署完成！**

### 📊 **确认信息**
- ✅ **安装位置**: `/opt/mcp-web-automation`
- ✅ **服务地址**: `http://your-server-ip:29527`
- ✅ **系统服务**: 已配置开机自启
- ✅ **日志轮转**: 已配置自动清理
- ✅ **管理别名**: 已添加便捷命令
- ✅ **API 密钥**: 已生成强密码

### 🚀 **开始使用**
现在可以在 AI 客户端中配置连接信息，开始使用网页自动化功能了！

**遇到问题？运行 `mcp-logs` 查看详细日志，或告诉我具体错误信息！**
