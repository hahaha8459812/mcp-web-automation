## 🚀 在 /opt 目录部署 MCP Web Automation Tool

> 在 Linux 系统的 /opt 目录下进行生产环境MCP部署

---

## 📋 **部署概述**

`/opt` 目录是 Linux 系统中安装第三方软件的标准位置，适合生产环境部署。

### 🎯 **MCP部署特性**
- **标准MCP协议**: 完全符合MCP规范
- **双模式支持**: stdio (本地) + HTTP/SSE (远程)
- **高性能**: 优化的浏览器管理和资源复用
- **易于维护**: 统一的服务管理和监控

---

## 1️⃣ **连接服务器并准备环境**

### 🔐 **连接到服务器**
```bash
# 通过 SSH 连接到服务器
ssh username@your-server-ip

# 切换到 root 用户（推荐）
sudo su -
# 或者每个命令前加 sudo
```

### 📋 **系统要求检查**
```bash
# 检查操作系统版本
cat /etc/os-release

# 检查可用内存（推荐 1GB+）
free -h

# 检查磁盘空间（推荐 2GB+）
df -h /opt

# 检查 CPU 核心数
nproc

# 输出示例:
# 内存: 1-2GB+ 可用
# 磁盘: 2GB+ 可用空间
# CPU: 1-2+ 核心
```

---

## 2️⃣ **安装系统依赖**

### 📦 **Ubuntu/Debian 系统**
```bash
# 更新包管理器
apt update && apt upgrade -y

# 安装基础依赖
apt install -y curl wget git build-essential

# 安装 Node.js 18+ (使用官方源)
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt install -y nodejs

# 安装 Chrome/Chromium
apt install -y chromium-browser
# 或者安装 Google Chrome
wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add -
echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list
apt update
apt install -y google-chrome-stable

# 安装其他工具
apt install -y jq htop ufw lsof
```

### 📦 **CentOS/RHEL 系统**
```bash
# 更新系统
yum update -y

# 安装基础依赖
yum groupinstall -y "Development Tools"
yum install -y curl wget git

# 安装 Node.js 18+
curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
yum install -y nodejs

# 安装 Chromium
yum install -y chromium

# 安装其他工具
yum install -y jq htop lsof
```

### ✅ **验证安装**
```bash
# 验证 Node.js 版本
node --version  # 应显示 v18.x.x 或更高

# 验证 npm 版本
npm --version

# 验证 Chrome/Chromium
which google-chrome || which chromium-browser

# 验证浏览器版本
google-chrome --version || chromium-browser --version
```

---

## 3️⃣ **下载和安装项目**

### 📁 **创建部署目录**
```bash
# 进入 /opt 目录
cd /opt

# 克隆项目（使用 MCP 分支）
git clone https://github.com/hahaha8459812/mcp-web-automation.git
cd mcp-web-automation

# 切换到 MCP 分支
git checkout feature/mcp-server-implementation

# 查看项目信息
ls -la
git branch
git log --oneline -5
```

### 📦 **安装项目依赖**
```bash
# 安装 npm 依赖
npm install

# 验证依赖安装
npm list --depth=0

# 检查关键依赖
npm list puppeteer
npm list @modelcontextprotocol/sdk
```

### ⚙️ **配置文件设置**
```bash
# 复制配置模板
cp mcp-config.example.json mcp-config.json

# 编辑配置文件
nano mcp-config.json
# 或使用 vim: vim mcp-config.json

# 创建必要目录
mkdir -p data logs

# 设置文件权限
chmod +x start-mcp.sh
chmod 644 mcp-config.json
chmod 755 data logs
```

#### 🔧 **生产环境配置示例**
```json
{
  "_comment": "生产环境 MCP 配置",
  "server": {
    "name": "web-automation-prod",
    "version": "1.0.0",
    "description": "生产环境MCP Web自动化工具"
  },
  "http": {
    "port": 29528,
    "host": "0.0.0.0"
  },
  "browser": {
    "headless": true,
    "timeout": 30000,
    "user_agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    "viewport": {
      "width": 1920,
      "height": 1080
    },
    "args": [
      "--no-sandbox",
      "--disable-setuid-sandbox",
      "--disable-dev-shm-usage",
      "--disable-gpu"
    ]
  },
  "logging": {
    "level": "info",
    "file": "logs/mcp-web-automation.log",
    "max_file_size": "50MB",
    "max_files": 10
  },
  "features": {
    "screenshots": {
      "enabled": true,
      "max_width": 1920,
      "max_height": 1080,
      "quality": 80
    },
    "bookmarks": {
      "enabled": true,
      "max_per_website": 200
    },
    "credentials": {
      "enabled": true,
      "encryption": true
    }
  }
}
```

---

## 4️⃣ **服务启动和测试**

### 🚀 **启动 MCP 服务**
```bash
# 启动 MCP HTTP 服务（后台运行）
./start-mcp.sh http

# 检查服务状态
./start-mcp.sh status

# 查看启动日志
./start-mcp.sh logs
```

### 🧪 **服务功能测试**
```bash
# 1. 健康检查测试
curl http://localhost:29528/health

# 期望输出:
# {
#   "status": "ok",
#   "message": "MCP Web Automation Server is running",
#   "version": "1.0.0",
#   "timestamp": "2023-12-01T10:00:00.000Z",
#   "protocols": ["stdio", "http-sse"],
#   "tools_count": 7
# }

# 2. MCP 连接测试
curl http://localhost:29528/mcp

# 3. 完整服务测试
./start-mcp.sh test

# 4. stdio 模式测试
timeout 5s ./start-mcp.sh stdio
```

### 📊 **监控系统资源**
```bash
# 查看进程状态
ps aux | grep node

# 查看内存使用
free -h

# 查看端口占用
lsof -i :29528

# 查看系统负载
top
htop
```

---

## 5️⃣ **防火墙和网络配置**

### 🔥 **配置防火墙 (UFW)**
```bash
# 启用防火墙
ufw enable

# 允许 SSH 连接
ufw allow ssh
ufw allow 22

# 允许 MCP HTTP 端口
ufw allow 29528

# 查看防火墙状态
ufw status numbered

# 输出示例:
# Status: active
# [1] 22/tcp         ALLOW IN    Anywhere
# [2] 29528/tcp      ALLOW IN    Anywhere
```

### 🔥 **配置防火墙 (firewalld)**
```bash
# CentOS/RHEL 系统使用 firewalld
systemctl enable firewalld
systemctl start firewalld

# 允许端口
firewall-cmd --permanent --add-port=29528/tcp
firewall-cmd --reload

# 查看已开放端口
firewall-cmd --list-ports
```

### 🌐 **网络连接测试**
```bash
# 本地连接测试
curl http://localhost:29528/health

# 外部连接测试（从其他机器）
curl http://your-server-ip:29528/health

# 检查网络监听
netstat -tlnp | grep 29528
```

---

## 6️⃣ **系统服务配置（systemd）**

### 📋 **创建 systemd 服务文件**

#### MCP HTTP 服务
```bash
# 创建 MCP HTTP 服务文件
cat > /etc/systemd/system/mcp-web-automation.service << 'EOF'
[Unit]
Description=MCP Web Automation Service
After=network.target
Wants=network.target

[Service]
Type=exec
User=root
WorkingDirectory=/opt/mcp-web-automation
ExecStart=/opt/mcp-web-automation/start-mcp.sh http
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=5
StartLimitInterval=60s
StartLimitBurst=3

# 环境变量
Environment=NODE_ENV=production
Environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# 进程管理
KillMode=mixed
KillSignal=SIGTERM
TimeoutStopSec=30

# 安全设置
NoNewPrivileges=true
PrivateTmp=true

# 日志设置
StandardOutput=journal
StandardError=journal
SyslogIdentifier=mcp-web-automation

[Install]
WantedBy=multi-user.target
EOF
```

### 🔧 **启用和管理服务**
```bash
# 重新加载 systemd 配置
systemctl daemon-reload

# 启用服务（开机自启）
systemctl enable mcp-web-automation

# 启动服务
systemctl start mcp-web-automation

# 查看服务状态
systemctl status mcp-web-automation

# 查看服务日志
journalctl -u mcp-web-automation -f

# 重启服务
systemctl restart mcp-web-automation

# 停止服务
systemctl stop mcp-web-automation
```

---

## 7️⃣ **日志管理和轮转**

### 📝 **配置 logrotate**
```bash
# 创建 logrotate 配置
cat > /etc/logrotate.d/mcp-web-automation << 'EOF'
/opt/mcp-web-automation/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    sharedscripts
    copytruncate
    postrotate
        systemctl reload mcp-web-automation || true
    endscript
}
EOF

# 测试 logrotate 配置
logrotate -d /etc/logrotate.d/mcp-web-automation

# 手动执行日志轮转（测试）
logrotate -f /etc/logrotate.d/mcp-web-automation
```

### 📊 **日志监控脚本**
```bash
# 创建日志监控脚本
cat > /opt/mcp-web-automation/scripts/monitor-logs.sh << 'EOF'
#!/bin/bash

LOG_FILE="/opt/mcp-web-automation/logs/mcp-http.log"
MAX_SIZE_MB=100

if [ -f "$LOG_FILE" ]; then
    SIZE=$(du -m "$LOG_FILE" | cut -f1)
    if [ $SIZE -gt $MAX_SIZE_MB ]; then
        echo "$(date): Log file size exceeded ${MAX_SIZE_MB}MB, rotating..."
        logrotate -f /etc/logrotate.d/mcp-web-automation
    fi
fi
EOF

chmod +x /opt/mcp-web-automation/scripts/monitor-logs.sh

# 添加到 crontab
echo "0 */6 * * * /opt/mcp-web-automation/scripts/monitor-logs.sh" | crontab -
```

---

## 8️⃣ **备份和维护**

### 💾 **创建备份脚本**
```bash
# 创建备份目录
mkdir -p /opt/backups/mcp-web-automation

# 创建备份脚本
cat > /opt/mcp-web-automation/scripts/backup.sh << 'EOF'
#!/bin/bash

BACKUP_DIR="/opt/backups/mcp-web-automation"
PROJECT_DIR="/opt/mcp-web-automation"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="mcp-backup-${DATE}.tar.gz"

echo "$(date): Starting backup..."

# 创建备份
tar -czf "${BACKUP_DIR}/${BACKUP_FILE}" \
    --exclude='node_modules' \
    --exclude='logs/*.log' \
    --exclude='.git' \
    -C /opt mcp-web-automation

echo "$(date): Backup created: ${BACKUP_FILE}"

# 保留最近7天的备份
find "$BACKUP_DIR" -name "mcp-backup-*.tar.gz" -mtime +7 -delete

echo "$(date): Backup completed"
EOF

chmod +x /opt/mcp-web-automation/scripts/backup.sh

# 测试备份
/opt/mcp-web-automation/scripts/backup.sh

# 设置定时备份（每天凌晨2点）
echo "0 2 * * * /opt/mcp-web-automation/scripts/backup.sh >> /var/log/mcp-backup.log 2>&1" | crontab -
```

### 🔄 **创建更新脚本**
```bash
# 创建更新脚本
cat > /opt/mcp-web-automation/scripts/update.sh << 'EOF'
#!/bin/bash

PROJECT_DIR="/opt/mcp-web-automation"
cd "$PROJECT_DIR"

echo "$(date): Starting update..."

# 备份当前版本
./scripts/backup.sh

# 停止服务
systemctl stop mcp-web-automation

# 拉取最新代码
git fetch origin
git pull origin feature/mcp-server-implementation

# 更新依赖
npm install

# 重启服务
systemctl start mcp-web-automation

# 等待服务启动
sleep 10

# 验证服务
if curl -s http://localhost:29528/health > /dev/null; then
    echo "$(date): Update completed successfully"
else
    echo "$(date): Update failed, service not responding"
    exit 1
fi
EOF

chmod +x /opt/mcp-web-automation/scripts/update.sh
```

---

## 9️⃣ **监控和告警**

### 📊 **系统监控脚本**
```bash
# 创建监控脚本
cat > /opt/mcp-web-automation/scripts/monitor.sh << 'EOF'
#!/bin/bash

SERVICE_NAME="mcp-web-automation"
HEALTH_URL="http://localhost:29528/health"
LOG_FILE="/var/log/mcp-monitor.log"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S'): $1" | tee -a "$LOG_FILE"
}

# 检查服务状态
if ! systemctl is-active --quiet "$SERVICE_NAME"; then
    log "ERROR: Service $SERVICE_NAME is not running"
    systemctl restart "$SERVICE_NAME"
    log "INFO: Attempted to restart $SERVICE_NAME"
fi

# 检查健康状态
if ! curl -s --max-time 10 "$HEALTH_URL" > /dev/null; then
    log "ERROR: Health check failed for $HEALTH_URL"
    systemctl restart "$SERVICE_NAME"
    log "INFO: Attempted to restart $SERVICE_NAME due to health check failure"
fi

# 检查内存使用
MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.0f", $3/$2 * 100.0}')
if [ "$MEMORY_USAGE" -gt 90 ]; then
    log "WARNING: High memory usage: ${MEMORY_USAGE}%"
fi

# 检查磁盘空间
DISK_USAGE=$(df /opt | tail -1 | awk '{print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 85 ]; then
    log "WARNING: High disk usage: ${DISK_USAGE}%"
fi

log "INFO: Monitor check completed"
EOF

chmod +x /opt/mcp-web-automation/scripts/monitor.sh

# 设置监控定时任务（每5分钟检查一次）
echo "*/5 * * * * /opt/mcp-web-automation/scripts/monitor.sh" | crontab -
```

### 📧 **邮件告警配置（可选）**
```bash
# 安装邮件工具
apt install -y mailutils  # Ubuntu/Debian
# 或者
yum install -y mailx      # CentOS/RHEL

# 配置告警脚本
cat > /opt/mcp-web-automation/scripts/alert.sh << 'EOF'
#!/bin/bash

ALERT_EMAIL="admin@yourdomain.com"
SERVICE_NAME="MCP Web Automation"

send_alert() {
    local subject="$1"
    local message="$2"
    
    echo "$message" | mail -s "[$SERVICE_NAME] $subject" "$ALERT_EMAIL"
}

# 示例：服务异常告警
if ! systemctl is-active --quiet mcp-web-automation; then
    send_alert "Service Down" "MCP Web Automation service is not running on $(hostname)"
fi
EOF

chmod +x /opt/mcp-web-automation/scripts/alert.sh
```

---

## 🔟 **性能优化**

### ⚡ **系统优化**
```bash
# 增加文件描述符限制
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# 优化内核参数
cat >> /etc/sysctl.conf << 'EOF'
# 网络优化
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 65536 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# 进程优化
kernel.pid_max = 4194304
vm.max_map_count = 262144
EOF

# 应用内核参数
sysctl -p
```

### 🔧 **应用优化配置**
```json
{
  "browser": {
    "headless": true,
    "timeout": 20000,
    "args": [
      "--no-sandbox",
      "--disable-setuid-sandbox",
      "--disable-dev-shm-usage",
      "--disable-gpu",
      "--disable-background-timer-throttling",
      "--disable-backgrounding-occluded-windows",
      "--disable-renderer-backgrounding",
      "--memory-pressure-off",
      "--max_old_space_size=1024"
    ]
  },
  "logging": {
    "level": "warn",
    "max_file_size": "20MB",
    "max_files": 5
  }
}
```

---

## 1️⃣1️⃣ **AI客户端连接配置**

### 💻 **本地 stdio 连接**
```json
{
  "mcpServers": {
    "web-automation": {
      "command": "ssh",
      "args": [
        "your-server-ip",
        "cd /opt/mcp-web-automation && node src/mcp-server.js"
      ]
    }
  }
}
```

### 🌐 **远程 HTTP 连接**
```json
{
  "mcpServers": {
    "web-automation": {
      "url": "http://your-server-ip:29528/mcp"
    }
  }
}
```

---

## 1️⃣2️⃣ **部署验证清单**

### ✅ **最终验证步骤**
```bash
# 1. 系统服务状态
systemctl status mcp-web-automation

# 2. 端口监听状态
lsof -i :29528

# 3. 健康检查
curl http://localhost:29528/health

# 4. 远程访问测试（从其他机器）
curl http://your-server-ip:29528/health

# 5. 日志检查
tail -f logs/mcp-http.log

# 6. 资源使用情况
free -h
df -h /opt

# 7. 防火墙状态
ufw status || firewall-cmd --list-ports

# 8. 自动启动测试
systemctl enable mcp-web-automation
reboot
# 重启后验证服务自动启动
```

### 📋 **部署成功指标**
- ✅ systemd 服务运行正常
- ✅ 端口 29528 正常监听
- ✅ 健康检查返回正常状态
- ✅ 远程可以访问服务
- ✅ 日志正常写入
- ✅ 系统资源使用合理
- ✅ 防火墙配置正确
- ✅ 服务开机自启动

---

## 🎉 **部署完成**

恭喜！您已成功在 `/opt` 目录部署了 MCP Web Automation Tool。

### 📞 **后续支持**
- 📊 定期检查监控日志：`tail -f /var/log/mcp-monitor.log`
- 🔄 定期更新版本：`/opt/mcp-web-automation/scripts/update.sh`
- 💾 确认备份正常：`ls -la /opt/backups/mcp-web-automation/`
- 📈 监控系统资源：`htop` 或 `top`

### 🔗 **连接信息**
- **MCP HTTP 端点**: `http://your-server-ip:29528/mcp`
- **健康检查**: `http://your-server-ip:29528/health`
- **SSH stdio 连接**: `ssh your-server-ip "cd /opt/mcp-web-automation && node src/mcp-server.js"`

**🚀 现在您可以在任何支持 MCP 的 AI 客户端中使用这个强大的网页自动化工具了！**
